FROM kalilinux/kali-rolling

ARG KALI_USER=kali
ARG KALI_PASSWORD=kali
ENV KALI_USER=${KALI_USER} \
    KALI_PASSWORD=${KALI_PASSWORD} \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8

# 安裝必要套件
RUN apt update && DEBIAN_FRONTEND=noninteractive apt install -y \
    xfce4 xfce4-goodies \
    tigervnc-standalone-server \
    websockify \
    git curl wget sudo net-tools \
    python3 python3-pip \
    openssh-server \
    x11-xserver-utils \
    expect locales && \
    sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && \
    locale-gen && \
    apt clean && rm -rf /var/lib/apt/lists/*

# 建立使用者
RUN useradd -ms /bin/bash $KALI_USER && \
    echo "$KALI_USER:$KALI_PASSWORD" | chpasswd && \
    echo "$KALI_USER ALL=(ALL:ALL) ALL" >> /etc/sudoers

# 設定 SSH
RUN mkdir -p /var/run/sshd && \
    echo "Port 22" >> /etc/ssh/sshd_config && \
    echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config && \
    echo "PermitRootLogin yes" >> /etc/ssh/sshd_config && \
    echo "X11Forwarding yes" >> /etc/ssh/sshd_config && \
    echo "X11UseLocalhost no" >> /etc/ssh/sshd_config

# 設定 VNC 密碼（使用 expect）
RUN mkdir -p /home/$KALI_USER/.vnc && \
    chown -R $KALI_USER:$KALI_USER /home/$KALI_USER && \
    echo '#!/usr/bin/expect\n\
    spawn vncpasswd\n\
    expect "Password:"\n\
    send "$env(KALI_PASSWORD)\r"\n\
    expect "Verify:"\n\
    send "$env(KALI_PASSWORD)\r"\n\
    expect "Would you like to enter a view-only password (y/n)?"\n\
    send "n\r"\n\
    interact' > /vnc_setpasswd.exp && \
    chmod +x /vnc_setpasswd.exp && \
    su - $KALI_USER -c "/vnc_setpasswd.exp"

# 安裝 noVNC
RUN git clone https://github.com/novnc/noVNC.git /opt/novnc && \
    ln -s /opt/novnc/vnc.html /opt/novnc/index.html

# 建立啟動腳本
RUN echo '#!/bin/bash\n\
    export DISPLAY=:1\n\
    vncserver :1 -geometry 1280x800 -depth 24\n\
    /opt/novnc/utils/novnc_proxy --vnc localhost:5901 --listen 6080' > /start-vnc.sh && \
    chmod +x /start-vnc.sh

# 開放連接埠
EXPOSE 22 5901 6080

# 啟動 VNC + noVNC
CMD ["/bin/bash", "/start-vnc.sh"]
